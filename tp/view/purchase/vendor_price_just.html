<?php //if($_SESSION['a1']['multi'] == 1) echo ("<script src='/a1/index/view/public/theme1/js/form.js'></script>");?>	
<style type="text/css">
		table.dataTable thead th{padding-left:0;padding-right:0}
	</style>

	<input type = 'hidden' value = '' id = 'ddh_hidden' />		
			<div class="card">
				
					<div class="card-content" >
							
							<div class = "row" >
								<div class = "col s1 center" >
									<div id = 'state_info' style = 'display:none'>
										<span id = 'state_info_img'>
										<img src = '__PUBLIC__/image/erp/status_saved.png' class = '' />
										<span>
										<br />
										<span id = 'state_info_text'>
										已审核
										</span>
									</div>
								</div>


								<div class = "col s3 center" >
									<div class = 'row'>
										<div class = 'col s3 erp-head'>
											日期
										</div>
										<div class = 'col s9 erp-head'>
											<input type = 'text' class = 'aya-input center vendor_code date border-bottom' data-hasdatefunction = 'off' readonly data-d = '' id = 'date' >
										</div>	
									</div>


									<div class = 'row'>
										<div class = 'col s3 erp-head'>
											制单人
										</div>
										<div class = 'col s9 erp-head'>
											<input type = 'text' class = 'aya-input center maker border-bottom' id = 'maker'    readonly   data-df = '{$Request.session.userinfo.name}'>
										</div>
									</div>
								</div>
								
								<div class = "col s1 c1enter" ></div>

								<div class = "col s3 c1enter" >

									<div class = 'row'>
										<div class = 'col s3 erp-head'>
											单号
										</div>
										<div class = 'col s9 erp-head' id = 'erp-head-ddh'>
											<input type = 'text' class = 'aya-input center ddh border-bottom' id = 'ddh' data-last = ''     value = '' >
											<img src = '__PUBLIC__/image/erp/arrow-up.png' class = ' height14' style = 'top:5px;right:0' id = 'ddh-next' />
											<img src = '__PUBLIC__/image/erp/arrow-down.png' class = ' height14' style = 'top:17px;right:0' id = 'ddh-prev' />

										</div>	
									</div>

								</div>
								
								<div class = "col s1 c1enter" ></div>
								
								
								<div class = "col s3 ">
									
									<div class = 'row'>

										<div class = 'col s2' style = 'padding:0;margin:0'>
											<div class = 'erp-head-div-new-container' style = 'width:40px;' >
												<div class = 'erp-head-div-new-top' id = 'new'>
													<img src = '__PUBLIC__/image/erp/new.png' />
												</div>
												<div class = 'erp-head-div-new-bottom' id = 'new_resource' >
													新增<br />▼
												</div>
											</div>
										</div>

										<div class = 'col s10' style = 'padding:0;margin:0'>
											

											
											<div class = 'erp-head-div-container'>
												<div class = 'erp-head-div-container-top'>
													<span class = 'erp-head-div-container-span-con img_off' id = 'save'>
														<span class = 'erp-head-div-container-span'>保存</span>
														<img src = '__PUBLIC__/image/erp/save_off.png'  class = 'height18' />
													<span>
												</div>
												
												<div class = 'erp-head-div-container-top'>
													<span class = 'erp-head-div-container-span-con img_off' id = 'modify'>
														<span class = 'erp-head-div-container-span'>修改</span>
														<img src = '__PUBLIC__/image/erp/modify_off.png'  class = 'height18' />
													</span>
												</div>
											</div>

											<div class = 'erp-head-div-container'>
												<div class = 'erp-head-div-container-top'>
													<span class = 'erp-head-div-container-span-con img_off' id = 'check'>
														<span class = 'erp-head-div-container-span'>审核</span><img src = '__PUBLIC__/image/erp/check_off.png'  class = 'height18' />
													<span>
												</div>
												<div class = 'erp-head-div-container-top'>
													<span class = 'erp-head-div-container-span-con img_off' id = 'uncheck'>
														<span class = 'erp-head-div-container-span'>弃审</span><img src = '__PUBLIC__/image/erp/uncheck_off.png'  class = 'height18' />
													</span>
												</div>
											</div>

											<div class = 'erp-head-div-container'>
												<div class = 'erp-head-div-container-top'>
													<span class = 'erp-head-div-container-span-con img_off' id = 'giveup'>
														<span class = 'erp-head-div-container-span'>放弃</span><img src = '__PUBLIC__/image/erp/giveup_off.png'  class = 'height18' />
													<span>
												</div>
											</div>
											
											<div class = 'erp-head-div-container'>
												<div class = 'erp-head-div-container-top'>
													<span class = 'erp-head-div-container-span-con img_off' id = 'dlt'>
														<span class = 'erp-head-div-container-span'>删除</span><img src = '__PUBLIC__/image/erp/dlt_off.png'  class = 'height18' />
													<span>
												</div>
											</div>

											<div class = 'erp-head-div-container'>
												<div class = 'erp-head-div-container-top'>
													<span class = 'erp-head-div-container-span-con img_off' id = 'flow'>
														<span class = 'erp-head-div-container-span'>流程</span><img src = '__PUBLIC__/image/erp/flow_off.png'  class = 'height18' />
													<span>
												</div>
											</div>
											
										</div>
									</div>
								</div>

							</div>
							


							<div class = 'row'>
								<div class = "col s12" style = 'text-align:left' id = 'table-con'>
									<table style = 'width:auto;margin-left:0' class = "dataTable centered cell-border hover table-small noselect aya-sort" id='table'  >
										<thead>
											<tr>
											<th style='min-width:50px;white-space:nowrap;'>序号</th>
											<th style='min-width:100px;white-space:nowrap;'>供应商编码</th>
											<th style='min-width:150px;white-space:nowrap;'>供应商名称</th>
											<th style='min-width:90px;white-space:nowrap;'>物料编码</th>
											<th style='min-width:120px;white-space:nowrap;'>物料名称</th>
											<th style='min-width:120px;white-space:nowrap;'>规格型号</th>
											<th style='min-width:50px;white-space:nowrap;'>单位</th>
											<th style='min-width:80px;white-space:nowrap;'>原价</th>
											<th style='min-width:80px;white-space:nowrap;'>原税率</th>
											<th style='min-width:80px;white-space:nowrap;'>原含税价</th>
											<th style='min-width:80px;white-space:nowrap;'>现价</th>
											<th style='min-width:80px;white-space:nowrap;'>现税率</th>
											<th style='min-width:80px;white-space:nowrap;'>现含税价</th>
											<th style='min-width:50px;white-space:nowrap;'>操作</th>
											</tr>
										</thead>
										<tbody id = 'tbody'>
											<tr>
										
												<td>1</td>
												<td class = 'td-input-img'>
													<input type = 'text' class = 'aya-input2 input-background center vendor_code edit' data-last = ''  readonly>
													<img src = '__PUBLIC__/image/erp/selectu8.png' class = 'input-hint height14  img-vendor select' />
												</td>
												<td class ='td-input-img'>
													<input type = 'text' class = 'aya-input2 center vendor_name' readonly >
												</td>
												<td class = 'td-input-img'>
													<input type = 'text' class = 'aya-input2 center inventory_code input-background center edit' data-last = '' readonly>
													<img src = '__PUBLIC__/image/erp/selectu8.png' class = 'input-hint height14  img-inventory select' />
												</td>


												<td class ='td-input-img'>
													<input type = 'text' class = 'aya-input2 inventory_name center' readonly>
												</td>
											
												<td class ='td-input-img'>
													<input type = 'text' class = 'aya-input2 inventory_std center' readonly>
												</td>
												<td class ='td-input-img'>
													<input type = 'text' class = 'aya-input2 inventory_unit center' readonly>
												</td>

												<td class ='td-input-img'>
													<input type = 'text' class = 'aya-input2  center origin_price' readonly>
												</td>
												<td class ='td-input-img'>
													<input type = 'text' class = 'aya-input2  center origin_tax' readonly>
												</td>
												<td class = 'td-input-img'>
													<input type = 'text' class = 'aya-input2  center  origin_tax_price' readonly>
												</td>

												<td class = 'td-input-img'>
													<input type = 'text' class = 'aya-input2 input-background center edit price mul-num' readonly>
												</td>
												<td class = 'td-input-img'>
													<select class = 'browser-default center tax'>
														<option value = '0'>0</option>
														<option value = '3'>3</option>
														<option value = '6'>6</option>
														<option value = '13' selected>13</option>

													</select>
												</td>

												

												<td class = 'td-input-img'>
													<input type = 'text' class = 'aya-input2  center  tax_price' readonly>
												</td>

												<td style='padding:0'><img src = '__PUBLIC__/image/erp/erase.png' class = 'height16 tr_dlt' style='margin:0' /> <img src = '__PUBLIC__/image/erp/add.png' class = 'height16 tr_add_next' style='margin:0' />
															

												</td>
											</tr>
										</tbody>
	
									</table>

								</div>
							</div>

							
							<div class = 'row' id = 'foot'>
								<div class = 'col s1' style = 'padding:10px;text-align:right;font-size:12px'>
									备注：
								</div>
								<div class = 'col s11'>
									<input type = 'text' class = 'aya-input' id = 'remark' style = 'border-top:0;border-left:0;border-right:0' />
								</div>
							</di>





					
				</div>
			</div>
	
	
	
	
	
	
	
	
	
	
	

	

<script>
	




	var resource_layero = {};

	var erpConfig = {
		type : 'page',

		bodySort : true,

		head:[
			{type : 'date' , id : 'date' , callback:''},
			{type : 'text' , id : 'maker', callback:''}
		],
		body:[
			{type : 'erp' , type2:'inventory',callback:update_price},
			{type : 'erp' , type2:'vendor',callback:update_price},
			{type : 'mul-num' , type2: 'mul-num' , callback : function(){
				$('#tbody tr').each(function(){
					let p = parseFloat($.trim($(this).children().eq(10).find('input').val()));
					if(!isNaN(p)){
						let s = decimal(p * ( 1 + $(this).children().eq(11).find('select').val() / 100),3) ;
						$(this).children().eq(12).find('input').val( s );
					}
				});
			}}
		],
		dataTableConfig:{scrollX:true,autoWidth:false,bAutoWidth: false},
		resource:[],
		get:{
			url : '__APP__/purchase/getVendorPriceJust',
			callback : ''
		},
		canModify:{
			url : '__APP__/purchase/canModifyVendorPriceJust',
			callback : ''
		},
		check:{
			url : '__APP__/purchase/checkVendorPriceJust',
			callback : ''
		},         
		uncheck:{
			url : '__APP__/purchase/uncheckVendorPriceJust',
			callback : ''
		},       
		dlt:{
			url : '__APP__/purchase/dltVendorPriceJust',
			callback : ''
		},             
		nextPrev : '__APP__/purchase/nextPrevVendorPriceJust',
		save : { url : '__APP__/Purchase/saveVendorPriceJust' },
		saveField : {
			main : ['date','remark'],
			listMust : ['inventory_code','vendor_code'],
			list : ['vendor_code','inventory_code','origin_price','origin_tax','origin_tax_price','price','tax','tax_price']
		},
	};

	add_tr('table',30);
	
	form.new_page_ini(erpConfig);

	

	function update_price(updated_tr_index){
		let o = {};
		let oo = [];
		
		let trs = $('#tbody').children();

		$(updated_tr_index).each(function(i,v){
			let tmp = {};
			tmp.vendor_code = $.trim(trs.eq(v).children().eq(1).find('input').val());
			tmp.inventory_code   = $.trim(trs.eq(v).children().eq(3).find('input').val());
			tmp.index  = v;
			
			if(tmp.vendor != '' && tmp.code != '') oo.push(tmp);
		});

		if(oo.length > 0){
			o.data = JSON.stringify(oo);
			$.post('__APP__/purchase/getVendorPriceByData',o,function(d){
				if(d.status == 's'){
					
					for(let i in d.data){
						for(let ii in d.data[i]){
							trs.eq(i).find('.'+ii).val(d.data[i][ii]);
						}
					}
						
				}else{
					layer.msg(d.info,{time:2000,offset:'30%'});
				}
			});
			
		}else{
			
		}
		
	}
	
	
	$('#tbody').on('keyup','input.price',function(){
		let price = parseFloat($(this).val());
		let tax   = parseFloat($(this).parents('td').next().find('select').eq(0).val());
		let sum = decimal(price  + price * tax / 100,3) ;
		if(isNaN(sum)) sum = '';
		$(this).parents('td').next().next().find('input').eq(0).val(sum);
	});


	$('#tbody').on('change','select.tax',function(){
		let p = $(this).parents('tr');
		let price = parseFloat(p.children().eq(10).find('input').val());
		let tax = parseFloat($(this).val());
		let sum = decimal(price  + price * tax / 100,3);
		p.children().eq(12).find('input').eq(0).val(sum);
	});


	

</script>
