

<div class="card">
	<div class="card-content">
		<div class = 'row row-head' >

			<div class = 'col s6'>
				标题：<input type = 'text' class = 'aya-input width-200' id = 'title' />
			</div>

			<div class = 'col s6'>
				
				<button class = 'btn btn-default btn-default-1' id = 'edit-form'>  <i class="material-icons text-color5"  >share</i> 编辑流程</button>

				<button class = 'btn btn-default btn-default-1' id = 'select-form'>  <i class="material-icons text-color5"  >subject</i> 流程模板</button>

				<button class = 'btn btn-default btn-default-1' id = 'send' >  <i class="material-icons text-color3"  >add_box</i> 发送</button>

			</div>
		</div>

		<div class = 'row row-body' id = 'form_content' style = 'background:#fff;text-align:center;padding:10px 0 0 0'>

			<textarea id = 'myEditor' style = 'margin:auto;display:inline-block'>

			</textarea>
			
</div>
		</div>
		
		


					
	</div>
</div>


<script>
	

	

	var app = {

		flow_template_id : 0,

		flow_node : '',

		flow_p : '',

		ue : {},

		template_id : 0,

		tmp : new Map(),

		mSelected: '',


		send: function( exc = ''){
			let o = {};
			if(app.template_id == 0){  // 自定义流程
				o.title = $.trim($('#title').val());
				o.p = JSON.stringify(app.flow_p);
				o.node = JSON.stringify(app.flow_node);
				o.form = app.ue.getContent();
			}
			if(exc != '') o.executor = exc;

			

			$.post('__APP__/Fs/send',o,function(d){

				
				if(d.status == 's'){
					layer_success('发送成功！',2000);
					$('#title').val('');
				}else if(d.status == 'e'){
					layer_error(d);
				}else if(d.status == 'm'){
				//选择审核人 - 开始

					app.tmp = new Map();
					let c = "<div style = 'font-size:12px;'>";
					for(let i in d.data){
						let zxmsName = '';
						if(d.data[i]['zxms'] == 1) zxmsName = '单人执行';
						if(d.data[i]['zxms'] == 2) zxmsName = '多人执行';
						c += "<div class = 'row' style = 'margin:0;padding:20px 10px;border-bottom:1px solid #bfbfbf'>"
						c += "<div class = 'col s3 hint1'>"+d.data[i]['name']+"</div><div class = 'col s3'>"+zxmsName+"</div><div class = 'col s6'><input placeholder = '点击选择执行人' id = '"+i+"' data-id = '"+i+"'  data-zxms = '"+d.data[i]['zxms']+"' type = 'text' class = 'aya-input xzfzclr' style = 'height:24px' readonly /></div>";
						c += "</div>";
						app.tmp.set(i,d.data[i]['list']);
					}

					c += "</div>";		
					
					let index = parent.layer.open({
						title : '<span style = "font-size:12px">选择分支处理人</span>',
						offset : ['48px'],
						area  : ['900px','660px'],
						type  : 1,
						btn   : ['确定'], //aya_mom_moallocate_change
						shadeClose:true,
						content : c,
						yes : function(){
							let a = [];
							let allSelected = true;
							parent.$('input.xzfzclr').each(function(){
								let tmp = {};
								tmp.id = $(this).data('id');
								if($(this).data('executor') == undefined || $(this).data('executor') == '[]'){
									allSelected = false;
									return false;
								}else{
									tmp.executor = $(this).data('executor');
								}
								a.push(tmp);
							});

							if(allSelected == false){
								layer.msg('请选择执行人',{icon:2,time:1500,offset:'30%'});
								return false;
							}
							app.send(JSON.stringify(a));
							layer.close(index);

						},
						success : function(layero, index){
							parent.$('input.xzfzclr').click(function(){

								let t = $(this).parent().prev().prev().text();

								let id = $(this).data('id');

								app.mSelected = id;

								let zxms = $(this).data('zxms');


								let n = "<div class = 'row' style = 'margin:0'><div class = 'col s12' id = 'top123'><div style = 'display:inline-block;width:50%;position:relative'><input id = 'i20191119' placeholder = '按回车搜索' type = 'text' class = 'aya-input' style = 'height:24px;width:100%' /><img class = 'icon4' src = '/a1/index/view/public/Image/o25.png' style = 'position:absolute;right:0;top:3px;'/></div></div><div class = 'col s12'><table id = 't20191119' class = 'centered dataTable row-border noselect table-small'><thead><tr></tr><tr><th></th><th>工号</th><th>姓名</th></tr></thead><tbody>";

								let selected = new Map();
								if(parent.$('#' + app.mSelected).data('executor') != undefined){
									JSON.parse(parent.$('#' + app.mSelected).data('executor')).forEach(function(v,k){
										selected.set(v.k,1);	
									});
								}
								
								let tmp1 = '',tmp2 = '';
								
								app.tmp.get(id).forEach(function(v,k){
									if(selected.get(v.k) == undefined){
										tmp1 += "<tr><td><input type = 'checkbox' class = 'aya-checkbox' /></td><td>"+v.k+"</td><td>"+v.v+"</td></tr>";
									}else{
										tmp2 += "<tr class = 'selected'><td><input type = 'checkbox' class = 'aya-checkbox' checked /></td><td>"+v.k+"</td><td>"+v.v+"</td></tr>";
									}
										
								});

								n = n + tmp2 + tmp1;

								n += "</tbody></table></div><div class = 'col s12 center' style = 'padding:8px' ><button class = 'btn btn-primary height32' id = 'btn20191119'>确定</button></div></div>";


						
								parent.layer.open({
									title : '<span class = "hint2" style = "font-size:12px">选择分支处理人（'+t+'）</span>',
									offset : ['48px'],
									area  : ['500px','660px'],
									type  : 1,
									shadeClose:false,
									content: n,
									success : function(layero2, index2){
										
										let scrollY = 562 - $('#top123').height()  - top.$('#btn20191119').parent().height();
										if(top.mainPage.multiType == 1) scrollY -= 26;

										let setting = {
											paging: false,
											scrollY: scrollY ,
											info:false,
											ordering:false,
											dom:'t',	
										};

										let t20191119 = parent.$('#t20191119').DataTable(setting);

										if(zxms == 1){
											parent.select_tr('t20191119');
										}else{
											parent.select_tr2('t20191119');
										}
										

											
										parent.$('#i20191119').keypress(function(e){
										
											let text = $.trim(parent.$('#i20191119').val());
											
											if(e.keyCode == 13){
												t20191119.search(text).draw();
											}
										});
											
										parent.$('#btn20191119').click(function(){
											let a = [];
											parent.$('#t20191119 tbody tr.selected').each(function(){
												let tmp = {};
												tmp.k = $(this).children().eq(1).text();
												tmp.v = $(this).children().eq(2).text();
												a.push(tmp);
											});
											if(a.length == 0){
												layer.msg('请选择执行人',{icon:2,time:1500,offset:'30%'});
											}else{
												parent.$('#'+app.mSelected).data('executor',JSON.stringify(a));
												let tmp = ''
												for(let i = 0; i < a.length; i++){
													if( i == a.length - 1){
														tmp += a[i]['v'];
													}else{
														tmp = tmp + a[i]['v'] + ',';
													}
												}
												$('#'+app.mSelected).val(tmp);
												parent.layer.close(index2);
											}
										});

									}
										
								});

							});

						},
					});








				// 选择审核人 - 结束
				}
			});



		},

		ini : function(){

			max_height('form_content',false);
			app.ue = UE.getEditor('myEditor',{initialFrameHeight:$('#form_content').height() - 100});
			$('.edui-container').height( $('#form_content').height() );
			
			
			

			$('#send').click(function(){
				app.send();
			});
			

			
			



			$('#edit-form').click(function(){
				layer.open({					
					type: 2,
					isOutAnim: false ,
					title: '<span class = "text-color2">编辑流程</span>',
					maxmin: true,
					shadeClose: true, //点击遮罩关闭层
					area : [parent.mainPage.layerWidth,'100%'],
					content: '__APP__/Fs/customFlow',
					success : function (layero,index){
						let top = ($('.layui-layer-title').eq($('.layui-layer').length - 1).height() - 32) / 2;
						let left = ($('.layui-layer-title').eq($('.layui-layer').length - 1).width() - 51) / 2;
						if(top < 0) top = 4.5;
						parent.$('.layui-layer').eq($('.layui-layer').length - 1).append('<button id = "flow_save" style = "position:absolute;top:'+top+'px;left:'+left+'px;z-index:9999999999;cursor:pointer" class = "btn btn-default height32 btn-noshadow">保存</button>');

						$('#flow_save').click(function(){
							var iframeWin = window[layero.find('iframe')[0]['name']];
							iframeWin.flow.save();
						});
					}
				});
			});
		}

		

	}


	app.ini();
	
</script>



